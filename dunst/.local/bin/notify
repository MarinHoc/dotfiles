#!/bin/sh
#
# send a notification using lemonbar

name=notify

. ~/.config/lemonbar/notify

# clear previous notification
cmd="killw \"\$(xdo id -a \"$name\")\""

eval "$cmd"

# fix formatting #1
[ "$3" ] && string="$2 - $3" || string=$2

[ ${#string} -gt 80 ] &&
    string=$(printf '%.80s...' "$string")

{
    echo "$font"

    wattr wh "$(lsw -r)"
} | {
    read -r f_n f_s
    read -r s_w s_h

    # get notification size
    w=$((`txtw -f "$f_n" -s "$f_s" "$string"` + padding * 2))
    h=$((`txth -f "$f_n" -s "$f_s" "$string"` + padding * 2))

    # fix formatting #2
    string=$(echo "$string" | sed 's|%|%%|g;:x;N;$!bx;s|\n| |g')

    # get notification offset
    x=$((s_w - w - offset_x))
    y=$((s_h - h - offset_y))

    {
        echo "%{c}%{A:$cmd:}$string%{A}"

        sleep "$time"
    } |
        lemonbar               \
            -F "$foreground"   \
            -B "$background"   \
            -g "${w}x$h+$x+$y" \
            -n "$name"         \
            -d                 \
            -f "$f_n:pixelsize=$f_s:antialias=false" | sh &
}
