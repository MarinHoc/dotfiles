#!/bin/sh
#
# notify - display a notification using n30f & imagemagick

dir=/tmp/notify

. ~/.config/notify/config

# fix formatting
[ "$3" ] && string="$2
$3" || string="$2"

string=$(echo "$string" | fold -s)

# find current notification
mkdir -p "$dir"

for file in "$dir/"*; do
    num=${file##*/}
    num=${num%.png}

    [ "$num" != \* ] &&
        [ "$num" -gt "${max:-0}" ] && max=$num
done

file=$dir/$((max + 1)).png

{
    echo "$font"
    wattr wh "$(lsw -r)"
} | {
    read -r font  size
    read -r scr_w scr_h

    # create initial popup
    convert                           \
        -background "$background"     \
        -fill "$foreground"           \
        -font "$font"                 \
        -pointsize "$size"            \
        -interline-spacing "$spacing" \
        -gravity center               \
        label:"$string"               \
        "$file"

    identify -format '%W %H' "$file" | {
        read -r img_w img_h

        img_w=$((img_w + padding * 2))
        img_h=$((img_h + padding * 2))

        # add padding to popup
        convert                         \
            -background "$background"   \
            -gravity center             \
            -extent "${img_w}x${img_h}" \
            "$file"                     \
            "$file"

        pop_x=$((scr_w - img_w - x_offset))
        pop_y=$((scr_h - img_h - y_offset))

        # clear previous notification
        killw -p "$(xdo id -a "$dir/$max.png")"

        # display popup
        n30f                                  \
            -x "$pop_x"                       \
            -y "$pop_y"                       \
            -c "killw -p \$(xdo id -a $file)" \
            -t "$file"                        \
            "$file" &

        # clear popup after timeout
        {
            sleep 5

            killw -p "$(xdo id -a "$file")"

            rm "$file"
        } &
    }
}
