#!/bin/sh
#
# focus - focus closest window in a given direction

# exit when the focused window is fullscreen
bspc query -N -n focused.fullscreen > /dev/null && exit

case $1 in
    east)  arg=xyi; sign=-gt;;
    west)  arg=xyi; sign=-lt;;
    north) arg=yxi; sign=-lt;;
    south) arg=yxi; sign=-gt
esac

set -f #disable globbing

# get coordinates of all windows on the focused desktop
wattr "$arg" $(targets focused normal) | {
    read -r cur_pos_1 cur_pos_2 cur_id

    while read -r win_pos_1 win_pos_2 win_id; do
        [ "$win_pos_1" "$sign" "$cur_pos_1" ] && {
            # get position relative to the focused window
            : $((diff_pos_1 = win_pos_1 - cur_pos_1))
            : $((diff_pos_2 = win_pos_2 - cur_pos_2))

            # get absolute values
            diff_pos_1=${diff_pos_1#-}
            diff_pos_2=${diff_pos_2#-}

            { [ ! "$min_1" ] ||
                [ \
                    $((
                        diff_pos_1  < min_1
                     || diff_pos_1 == min_1
                     && diff_pos_2  < min_2
                     )) -eq 1 \
                ]; } && {
                min_1=$diff_pos_1
                min_2=$diff_pos_2
                focus=$win_id
            }
        }
    done

    bspc node "${focus:-$cur_id}" -f && cursor
}
