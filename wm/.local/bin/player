#!/bin/sh
#
# player - control currently playing media player

DIR=/tmp/mpv

# send a notification when fullscreen & changing playing file
bspc query -N -n focused.fullscreen > /dev/null && test "$1" != toggle &&
    notify=1

pgrep -x mpv > /dev/null && {
    # handle multiple mpv sockets
    for socket in "$DIR/"*; do
        num=${socket##*/}

        [ "$num" -gt "${max:-0}" ] &&
            max=$num
    done

    socket=$DIR/$max

    case $1 in
        toggle)    echo "cycle pause" | socat - "$socket";;
        next|prev) echo "playlist-$1" | socat - "$socket"
    esac

    test "$notify" &&
        echo '{ "command" : [ "get_property", "media-title" ] }' |
            socat - "$socket" | {
                read -r out

                # parse output
                out=${out#*:\"}
                out=${out%\",*}

                dunstify -r 500 "$out"
            }

    :
} || mpc "$1" 2> /dev/null | {
    read -r out

    test "$notify" &&
        dunstify -r 500 "$out"
}
