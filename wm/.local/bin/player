#!/bin/sh
#
# player - media player control

die() {
    printf '%s\n' "${1:-usage : ${0##*/} <prev|next|toggle>}" >&2

    exit 1
}

_() playerctl -p "$player" "$@"

# basic argument parsing
case $* in
    prev|next|toggle) ;;
    *)
        die
esac

# send a notification when fullscreen & changing media
{
    bspc query -N -n focused.fullscreen > /dev/null && [ "$1" != toggle ]
}               \
    && notify=1 \
    || notify=0

# find most recent media player
playerctl -l 2> /dev/null | {
    unset player

    while read -r line; do
        player=$line
    done

    test "$player" && {
        case $* in
            toggle) _ play-pause;;
            prev)   _ previous;;
            next)   _ next;;
        esac

        test "$notify" && {
            # wait for metadata to settle
            old_metadata=$(_ metadata)

            while :; do
                sleep .1

                new_metadata=$(_ metadata)

                [ "$new_metadata" = "$old_metadata" ] &&
                    break

                old_metadata=$new_metadata
            done

            dunstify -r 500 "$(_ metadata xesam:title)"
        }

        :
    } || mpc "$*" 2> /dev/null | {
        read -r out

        test "$notify" &&
            dunstify -r 500 "$out"
    }
}
