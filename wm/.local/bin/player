#!/bin/sh
#
# player - control currently playing media player

_() playerctl -p "$player" "$@"

# send a notification when fullscreen & changing playing file
bspc query -N -n focused.fullscreen > /dev/null && test "$1" != toggle &&
    notify=1

pgrep -x mpv > /dev/null && {
    # find latest instance
    playerctl -l 2> /dev/null | {
        while read -r line; do
            case $line in
                mpv*) player=$line
            esac
        done

        case $1 in
            toggle) _ play-pause;;
            prev)   _ previous;;
            next)   _ next
        esac

        test "$notify" && {
            # wait for metadata to become available
            until [ "$(_ metadata 'mpris:length')" ]; do
                sleep .1
            done

            out=$(_ metadata -f '{{title}}')

            dunstify -r 500 "$out"
        }
    }

    :
} || mpc "$1" 2> /dev/null | {
    read -r out

    test "$notify" &&
        dunstify -r 500 "$out"
}
