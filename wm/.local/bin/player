#!/bin/sh
#
# player - control currently playing media player

_() playerctl -p "$player" "$@"

# send a notification when fullscreen & changing playing file
bspc query -N -n focused.fullscreen > /dev/null && test "$1" != toggle &&
    notify=1

# find latest instance
playerctl -l 2> /dev/null | {
    while read -r line; do
        player=$line
    done

    [ "$player" ] && {
        case $1 in
            toggle) _ play-pause;;
            prev)   _ previous;;
            next)   _ next
        esac

        test "$notify" && {
            # try to wait for metadata to settle
            old=$(_ metadata)

            while :; do
                sleep .1; new=$(_ metadata)

                [ "$old" = "$new" ] && break || old=$new
            done

            out=$(_ metadata 'xesam:title')

            dunstify -r 500 "$out"
        }

        :
    } || mpc "$1" 2> /dev/null | {
        read -r out

        test "$notify" &&
            dunstify -r 500 "$out"
    }
}
